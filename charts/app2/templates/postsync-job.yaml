{{- if or (eq .Values.env "dev") (eq .Values.env "qa") }}
apiVersion: batch/v1
kind: Job
metadata:
  name: promote-{{ .Chart.Name }}-{{ .Values.env }}-to-next-{{ randAlphaNum 4 | lower }}
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
  annotations:
    argocd.argoproj.io/hook: PostSync
spec:
  backoffLimit: 1
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: promote
          image: alpine/git:2.45.2   # âœ… CLI image with argocd binary
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              APP_NAME="{{ .Chart.Name }}"
              CURRENT_ENV="{{ .Values.env }}"
              apk add --no-cache bash curl github-cli
              echo "ðŸ”¹ Installing ArgoCD CLI..."
              curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/v2.14.19/argocd-linux-amd64
              chmod +x /usr/local/bin/argocd
              echo "ðŸ”¹ Promotion hook triggered for {{ .Chart.Name }} ({{ .Values.env }})"

              case "{{ .Values.env }}" in
                dev)
                  NEXT_ENV="qa"
                  ;;
                qa)
                  NEXT_ENV="prod"
                  ;;
                *)
                  echo "No promotion required for {{ .Values.env }}"
                  exit 0
                  ;;
              esac

              echo "Next environment is: ${NEXT_ENV}"
              
              # âœ… Step 1: Login first
              ARGOCD_ADMIN_PWD="in2tCSuTIp2nA4qL"   # <-- Hardcoded for testing
              argocd login argocd-server.argocd.svc.cluster.local:443 \
                --username admin \
                --password "${ARGOCD_ADMIN_PWD}" \
                --grpc-web --insecure

              
              # Wait for this app to reach Healthy+Synced
              until argocd app get {{ .Chart.Name }}-{{ .Values.env }} --grpc-web --insecure \
                    | grep -q 'Health Status: *Healthy'; do
                echo "â³ Still waiting for {{ .Chart.Name }}..."
                sleep 100000
              done


              echo "âœ… {{ .Chart.Name }} is healthy. Moving to next sync wave..."
{{- end }}
