{{- if or (eq .Values.env "dev") (eq .Values.env "qa") }}
apiVersion: batch/v1
kind: Job
metadata:
  name: promote-{{ .Chart.Name }}-{{ .Values.env }}-to-next-{{ randAlphaNum 4 | lower }}
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
  annotations:
    argocd.argoproj.io/hook: PostSync
spec:
  backoffLimit: 1
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: promote
          image: alpine/git:2.45.2   # ‚úÖ CLI image with argocd binary
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              APP_NAME="{{ .Chart.Name }}"
              CURRENT_ENV="{{ .Values.env }}"
              apk add --no-cache bash curl github-cli
              echo "üîπ Installing ArgoCD CLI..."
              curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/v2.14.19/argocd-linux-amd64
              chmod +x /usr/local/bin/argocd
              echo "üîπ Promotion hook triggered for {{ .Chart.Name }} ({{ .Values.env }})"

              case "{{ .Values.env }}" in
                dev)
                  NEXT_ENV="qa"
                  ;;
                qa)
                  NEXT_ENV="prod"
                  ;;
                *)
                  echo "No promotion required for {{ .Values.env }}"
                  exit 0
                  ;;
              esac

              echo "Next environment is: ${NEXT_ENV}"
              
              # ‚úÖ Step 1: Login first
              ARGOCD_ADMIN_PWD="in2tCSuTIp2nA4qL"   # <-- Hardcoded for testing
              argocd login argocd-server.argocd.svc.cluster.local:443 \
                --username admin \
                --password "${ARGOCD_ADMIN_PWD}" \
                --grpc-web --insecure

              
              #!/bin/bash

              APP_NAME="{{ .Chart.Name }}-{{ .Values.env }}"
              echo "üîç Waiting for Argo CD app '$APP_NAME' to reach Synced + Healthy state..."

              # Timeout after 10 minutes (600s)
              TIMEOUT=600
              INTERVAL=10
              START_TIME=$(date +%s)

              while true; do
                STATUS=$(argocd app get "$APP_NAME" --grpc-web --insecure 2>/dev/null)

                HEALTH=$(echo "$STATUS" | grep -Eo "Health Status:\s+\S+" | awk '{print $3}')
                SYNC=$(echo "$STATUS" | grep -Eo "Sync Status:\s+\S+" | awk '{print $3}')
                LAST_SYNC=$(echo "$STATUS" | grep -E "Last Synced" || true)

                if [[ "$HEALTH" == "Healthy" && "$SYNC" == "Synced" && -n "$LAST_SYNC" ]]; then
                  echo "‚úÖ ArgoCD app '$APP_NAME' is Synced and Healthy!"
                  break
                else
                  echo "‚è≥ Waiting... Health=$HEALTH, Sync=$SYNC, LastSyncDetected=$([[ -n "$LAST_SYNC" ]] && echo yes || echo no)"
                fi

                # Timeout check
                CURRENT_TIME=$(date +%s)
                ELAPSED=$((CURRENT_TIME - START_TIME))
                if [[ $ELAPSED -ge $TIMEOUT ]]; then
                  echo "‚ùå Timeout waiting for '$APP_NAME' to reach Synced + Healthy."
                  exit 1
                fi

                sleep $INTERVAL
              done


              echo "‚úÖ {{ .Chart.Name }} is healthy. Moving to next sync wave..."
{{- end }}
