{{- if or (eq .Values.env "dev") (eq .Values.env "qa") (eq .Values.env "prod") }}
apiVersion: batch/v1
kind: Job
metadata:
  name: promote-{{ .Chart.Name }}-{{ .Values.env }}-to-next-{{ randAlphaNum 4 | lower }}
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
  annotations:
    argocd.argoproj.io/hook: PostSync
spec:
  backoffLimit: 1
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: promote
          image: alpine/git:2.45.2
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              APP="{{ .Chart.Name }}"
              ENV="{{ .Values.env }}"

              apk add --no-cache bash curl github-cli
              echo "üîπ Installing ArgoCD CLI..."
              curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/v2.14.19/argocd-linux-amd64
              chmod +x /usr/local/bin/argocd

              echo "üîπ ArgoCD Promotion Hook triggered for $APP ($ENV)"

              # Decide next environment
              case "$ENV" in
                dev)
                  NEXT_ENV="qa"
                  ;;
                qa)
                  NEXT_ENV="prod"
                  ;;
                prod)
                  echo "‚úÖ Production reached; no further promotion."
                  exit 0
                  ;;
                *)
                  echo "‚ùå Unknown environment: $ENV"
                  exit 1
                  ;;
              esac

              echo "Next environment is: ${NEXT_ENV}"

              # üîπ Step 1: ArgoCD Login
              echo "üîπ Logging in to ArgoCD..."
              argocd login argocd-server.argocd.svc.cluster.local:443 \
                --username admin \
                --password "${ARGOCD_ADMIN_PWD}" \
                --grpc-web --insecure

              # üîπ Step 2: Sequentially ensure apps are healthy before next
              echo "üîπ Waiting for all apps in ${ENV} to be Healthy and Synced..."
              for a in app1 app2 app3 app4 app5; do
                APP_FULL="${a}-${ENV}"
                echo "üîç Checking ${APP_FULL} status..."
                until argocd app get ${APP_FULL} --grpc-web --insecure | grep -q 'Health Status: *Healthy'; do
                  echo "‚è≥ Still waiting for ${APP_FULL}..."
                  sleep 10
                done
                echo "‚úÖ ${APP_FULL} is Healthy!"
              done

              echo "üéØ All ${ENV} apps are healthy; starting promotion to ${NEXT_ENV}"

              # üîπ Step 3: Clone repo and prepare PR
              apk add --no-cache git
              git config --global user.email "bot@argocd.local"
              git config --global user.name "ArgoCD Bot"

              echo "üîπ Cloning GitHub repository..."
              git clone https://${GITHUB_USER}:${GITHUB_PAT}@github.com/rajaramiotfal/sample-argocd-helm-5appsdd.git repo
              cd repo

              # Copy app-values.yaml from current env to next env
              cp envs/${ENV}/app-values.yaml envs/${NEXT_ENV}/app-values.yaml

              BRANCH="promote-${APP}-${NEXT_ENV}-$(date +%s)"
              git checkout -b $BRANCH

              if git diff --quiet envs/${NEXT_ENV}/app-values.yaml; then
                echo "‚ö†Ô∏è No changes to promote for ${NEXT_ENV}, skipping PR creation."
                exit 0
              fi

              echo "üîπ Committing promotion changes..."
              git add envs/${NEXT_ENV}/app-values.yaml
              git commit -m "Promote ${APP} from ${ENV} ‚Üí ${NEXT_ENV}"
              git push origin $BRANCH

              echo "üîπ Creating Pull Request..."
              gh pr create \
                --repo rajaramiotfal/sample-argocd-helm-5appsdd \
                --base main \
                --head $BRANCH \
                --title "Promote ${APP} from ${ENV} ‚Üí ${NEXT_ENV}" \
                --body "Automated promotion triggered after successful healthy sync of all ${ENV} apps."

              echo "‚úÖ Promotion PR created successfully!"
          env:
            - name: GITHUB_USER
              valueFrom:
                secretKeyRef:
                  name: github-secret
                  key: username
            - name: GITHUB_PAT
              valueFrom:
                secretKeyRef:
                  name: github-secret
                  key: password
            - name: GH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: github-secret
                  key: token
            - name: ARGOCD_ADMIN_PWD
              valueFrom:
                secretKeyRef:
                  name: argocd-initial-admin-secret
                  key: password
{{- end }}
