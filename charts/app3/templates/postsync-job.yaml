{{- if or (eq .Values.env "dev") (eq .Values.env "qa") (eq .Values.env "prod") }}
apiVersion: batch/v1
kind: Job
metadata:
  name: promote-{{ .Chart.Name }}-{{ .Values.env }}-to-next-{{ randAlphaNum 4 | lower }}
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded,HookFailed
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 1
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: promote
          image: alpine/git:2.45.2   # ‚úÖ CLI image with argocd binary
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              APP_NAME="{{ .Chart.Name }}"
              CURRENT_ENV="{{ .Values.env }}"
              apk add --no-cache bash curl jq git yq github-cli
              echo "üîπ Installing ArgoCD CLI..."
              curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/v2.14.19/argocd-linux-amd64
              chmod +x /usr/local/bin/argocd
            
              echo "‚úÖ {{ .Chart.Name }} is healthy. Moving to next sync wave..."
              echo "üîπ Promotion hook triggered for {{ .Chart.Name }} ({{ .Values.env }})"

              case "{{ .Values.env }}" in
                dev)
                  NEXT_ENV="qa"
                  ;;
                qa)
                  NEXT_ENV="prod"
                  ;;
                prod)
                  echo "üü¢ Current environment is prod ‚Äî updating prod image tags locally"
                  apk add --no-cache yq >/dev/null 2>&1
                  apk add --no-cache git github-cli bash curl

                  git config --global user.email "bot@argocd.local"
                  git config --global user.name "ArgoCD Bot"

                  echo "üîπ Cloning repository..."
                  git clone https://${GITHUB_USER}:${GITHUB_PAT}@github.com/rajaramiotfal/sample-argocd-helm-5appsdd.git repo
                  cd repo

                  for app in app1 app2 app3 app4 app5; do
                    CUR_TAG=$(yq e ".${app}.image.tag" envs/prod/app-values.yaml)
                    if [ "$CUR_TAG" != "null" ]; then
                      echo "  ‚û§ Ensuring ${app} tag = ${CUR_TAG}"
                      yq e -i ".${app}.image.tag = \"$CUR_TAG\"" envs/prod/app-values.yaml
                    fi
                  done

                  git add envs/prod/app-values.yaml
                  git commit -m "Sync prod image tags with latest releases"
                  git push origin main
                  echo "‚úÖ Prod image tags refreshed. No further promotion required."
                  exit 0
                  ;;
                *)
                  echo "No promotion required for {{ .Values.env }}"
                  exit 0
                  ;;
              esac

              until argocd app get {{ .Chart.Name }}-{{ .Values.env }} --grpc-web --insecure \
                        | grep -q 'Health Status: *Healthy'; do
                    echo "‚è≥ Still waiting for {{ .Chart.Name }}..."
                    sleep 10
                done 

              echo "Next environment is: ${NEXT_ENV}"
              NEXT_APP="{{ .Chart.Name }}-${NEXT_ENV}"
              echo "üîπ Preparing promotion PR for ${NEXT_APP}"

              # ‚úÖ Step 1: Login first
              ARGOCD_ADMIN_PWD="xETEiQf5PXpQiv8F"   # <-- Hardcoded for testing
              argocd login argocd-server.argocd.svc.cluster.local:443 \
                --username admin \
                --password "${ARGOCD_ADMIN_PWD}" \
                --grpc-web --insecure
                # Wait for this app to reach Healthy+Synced

               

              apk add --no-cache git github-cli bash curl

              git config --global user.email "bot@argocd.local"
              git config --global user.name "ArgoCD Bot"

              echo "üîπ Cloning repository..."
              git clone https://${GITHUB_USER}:${GITHUB_PAT}@github.com/rajaramiotfal/sample-argocd-helm-5appsdd.git repo
              cd repo

               echo "üîç Updating image tags in envs/${NEXT_ENV}/app-values.yaml..."
              for app in app1 app2 app3 app4 app5; do
                CUR_TAG=$(yq e ".${app}.image.tag" envs/${CURRENT_ENV}/app-values.yaml)
                if [ "$CUR_TAG" != "null" ]; then
                  echo "  ‚û§ $app ‚Üí tag=$CUR_TAG"
                  yq e -i ".${app}.image.tag = \"$CUR_TAG\"" envs/${NEXT_ENV}/app-values.yaml
                fi
              done

              # Detect and reuse existing PR branch
              BRANCH_NAME="promote-${APP_NAME}-${CURRENT_ENV}-to-${APP_NAME}-${NEXT_ENV}"

              if git ls-remote --heads origin ${BRANCH_NAME} | grep -q ${BRANCH_NAME}; then
                echo "‚ö†Ô∏è Branch ${BRANCH_NAME} already exists, skipping PR creation."
                exit 0
              fi

              git checkout -b ${BRANCH_NAME}
              git add envs/${NEXT_ENV}/app-values.yaml
              git commit -m "Promote ${NEXT_APP} from {{ .Values.env }} to ${NEXT_ENV}"
              git push origin ${BRANCH_NAME}

              # Create PR only if no existing one
              gh pr create --base main --head ${BRANCH_NAME} \
                --title "Promote ${APP_NAME} to ${NEXT_ENV}" \
                --body "Automated promotion from ${CURRENT_ENV} ‚Üí ${NEXT_ENV}"  

              # ‚úÖ Step 3: Wait until it's healthy
              argocd app wait ${NEXT_APP} \
                --health --timeout 300 --grpc-web --insecure

              echo "‚úÖ ${NEXT_APP} promotion completed successfully!"
          env:
            - name: GITHUB_USER
              valueFrom:
                secretKeyRef:
                  name: github-secret
                  key: username
            - name: GITHUB_PAT
              valueFrom:
                secretKeyRef:
                  name: github-secret
                  key: password
            - name: GH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: github-secret
                  key: token
{{- end }}
