{{- if or (eq .Values.env "dev") (eq .Values.env "qa") }}
apiVersion: batch/v1
kind: Job
metadata:
  name: promote-{{ .Chart.Name }}-{{ .Values.env }}-{{ randAlphaNum 4 | lower }}
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded,HookFailed
spec:
  backoffLimit: 1
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: promote
          image: alpine/git:2.45.2
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              APP="{{ .Chart.Name }}"
              ENV="{{ .Values.env }}"

              apk add --no-cache bash curl github-cli
              echo "üîπ Installing ArgoCD CLI..."
              curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/v2.14.19/argocd-linux-amd64
              chmod +x /usr/local/bin/argocd

              echo "üîπ PostSync hook triggered for $APP ($ENV)"

              apt-get update && apt-get install -y jq

              case "$ENV" in
                dev)
                  NEXT_ENV="qa"
                  ;;
                qa)
                  NEXT_ENV="prod"
                  ;;
                *)
                  echo "‚úÖ No promotion needed for $ENV"
                  exit 0
                  ;;
              esac

              echo "Next environment is: ${NEXT_ENV}"

              # Step 1 ‚Äî Wait for THIS app to be Healthy + Synced + Last Sync OK
              echo "üîπ Waiting for $APP-$ENV to become Healthy & Synced..."
              MAX_RETRIES=20
              COUNT=0

              while true; do
                APP_STATUS=$(argocd app get $APP-$ENV --grpc-web --insecure --output json | jq -r '.status.health.status')
                SYNC_STATUS=$(argocd app get $APP-$ENV --grpc-web --insecure --output json | jq -r '.status.sync.status')
                LAST_SYNC=$(argocd app get $APP-$ENV --grpc-web --insecure | grep -E 'Last Sync' | awk '{print $3}')

                echo "üîç Health=$APP_STATUS, Sync=$SYNC_STATUS, LastSync=$LAST_SYNC"

                if [ "$APP_STATUS" = "Healthy" ] && [ "$SYNC_STATUS" = "Synced" ]; then
                  echo "‚úÖ $APP-$ENV is Healthy, Synced and stable!"
                  break
                fi

                COUNT=$((COUNT + 1))
                if [ $COUNT -ge $MAX_RETRIES ]; then
                  echo "‚ùå Timeout waiting for $APP-$ENV (Health=$APP_STATUS, Sync=$SYNC_STATUS)"
                  exit 1
                fi

                sleep 10
              done

              # ‚úÖ Step 1: Login first
              ARGOCD_ADMIN_PWD="in2tCSuTIp2nA4qL"   # <-- Hardcoded for testing
              argocd login argocd-server.argocd.svc.cluster.local:443 \
                --username admin \
                --password "${ARGOCD_ADMIN_PWD}" \
                --grpc-web --insecure


              # Step 3 ‚Äî Clone repo and promote to next env
              git config --global user.email "bot@argocd.local"
              git config --global user.name "ArgoCD Bot"
              git clone https://${GITHUB_USER}:${GITHUB_PAT}@github.com/rajaramiotfal/sample-argocd-helm-5appsdd.git repo
              cd repo

              cp envs/${ENV}/app-values.yaml envs/${NEXT_ENV}/app-values.yaml

              BRANCH="promote-${APP}-${NEXT_ENV}-$(date +%s)"
              git checkout -b $BRANCH

              if git diff --quiet envs/${NEXT_ENV}/app-values.yaml; then
                echo "‚ö†Ô∏è No changes to promote for ${NEXT_ENV}, skipping PR creation."
                exit 0
              fi

              git add envs/${NEXT_ENV}/app-values.yaml
              git commit -m "Promote ${APP} from ${ENV} ‚Üí ${NEXT_ENV}"
              git push origin $BRANCH

              echo "üîπ Creating Pull Request..."
              gh pr create \
                --repo rajaramiotfal/sample-argocd-helm-5appsdd \
                --base main \
                --head $BRANCH \
                --title "Promote ${APP} from ${ENV} ‚Üí ${NEXT_ENV}" \
                --body "Automated promotion after successful Healthy sync for ${APP} (${ENV})."

              echo "‚úÖ Promotion PR created successfully!"
          env:
            - name: GITHUB_USER
              valueFrom:
                secretKeyRef:
                  name: github-secret
                  key: username
            - name: GITHUB_PAT
              valueFrom:
                secretKeyRef:
                  name: github-secret
                  key: password
            - name: GH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: github-secret
                  key: token

{{- end }}
